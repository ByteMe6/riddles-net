import { useState, useEffect, useContext } from 'react';
import { auth, db } from './firebaseConfig';
import { ref, set, get } from 'firebase/database';
import './RiddleChat.scss';
import "/public/gemini-logo.png";
import { LangContext } from './App';

const API_KEY = import.meta.env.VITE_API_KEY;
const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${API_KEY}`;

const translations = {
  eng: {
    title: 'Riddles from AI',
    description: 'Here will be some riddles generated by AI (Gemini).',
    getRiddle: 'Get a riddle',
    generating: 'Generating...',
    check: 'Check',
    correct: 'Correct! ðŸŽ‰. You can click "get a riddle" and get another one',
    incorrect: 'Incorrect. Try another one (click get a riddle)!',
    answer: 'Answer:',
    riddle: 'Riddle:',
    yourAnswer: 'Your answer...'
  },
  ru: {
    title: 'Ð—Ð°Ð³Ð°Ð´ÐºÐ¸ Ð¾Ñ‚ Ð˜Ð˜',
    description: 'Ð—Ð´ÐµÑÑŒ Ð±ÑƒÐ´ÑƒÑ‚ Ð·Ð°Ð³Ð°Ð´ÐºÐ¸, ÑÐ³ÐµÐ½ÐµÑ€Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ñ‹Ðµ Ð˜Ð˜ (Gemini).',
    getRiddle: 'ÐŸÐ¾Ð»ÑƒÑ‡Ð¸Ñ‚ÑŒ Ð·Ð°Ð³Ð°Ð´ÐºÑƒ',
    generating: 'Ð“ÐµÐ½ÐµÑ€Ð¸Ñ€ÑƒÐµÑ‚ÑÑ...',
    check: 'ÐŸÑ€Ð¾Ð²ÐµÑ€Ð¸Ñ‚ÑŒ',
    correct: 'Ð’ÐµÑ€Ð½Ð¾! ðŸŽ‰. ÐœÐ¾Ð¶ÐµÑ‚Ðµ Ð½Ð°Ð¶Ð°Ñ‚ÑŒ "Ð¿Ð¾Ð»ÑƒÑ‡Ð¸Ñ‚ÑŒ Ð·Ð°Ð³Ð°Ð´ÐºÑƒ" Ð¸ Ð¿Ð¾Ð»ÑƒÑ‡Ð¸Ñ‚ÑŒ Ð½Ð¾Ð²ÑƒÑŽ',
    incorrect: 'ÐÐµÐ²ÐµÑ€Ð½Ð¾. ÐŸÐ¾Ð¿Ñ€Ð¾Ð±ÑƒÐ¹Ñ‚Ðµ Ð´Ñ€ÑƒÐ³ÑƒÑŽ (Ð½Ð°Ð¶Ð¼Ð¸Ñ‚Ðµ Ð¿Ð¾Ð»ÑƒÑ‡Ð¸Ñ‚ÑŒ Ð·Ð°Ð³Ð°Ð´ÐºÑƒ)!',
    answer: 'ÐžÑ‚Ð²ÐµÑ‚:',
    riddle: 'Ð—Ð°Ð³Ð°Ð´ÐºÐ°:',
    yourAnswer: 'Ð’Ð°Ñˆ Ð¾Ñ‚Ð²ÐµÑ‚...'
  },
  ua: {
    title: 'Ð—Ð°Ð³Ð°Ð´ÐºÐ¸ Ð²Ñ–Ð´ Ð¨Ð†',
    description: 'Ð¢ÑƒÑ‚ Ð±ÑƒÐ´ÑƒÑ‚ÑŒ Ð·Ð°Ð³Ð°Ð´ÐºÐ¸, Ð·Ð³ÐµÐ½ÐµÑ€Ð¾Ð²Ð°Ð½Ñ– Ð¨Ð† (Gemini).',
    getRiddle: 'ÐžÑ‚Ñ€Ð¸Ð¼Ð°Ñ‚Ð¸ Ð·Ð°Ð³Ð°Ð´ÐºÑƒ',
    generating: 'Ð“ÐµÐ½ÐµÑ€ÑƒÑ”Ñ‚ÑŒÑÑ...',
    check: 'ÐŸÐµÑ€ÐµÐ²Ñ–Ñ€Ð¸Ñ‚Ð¸',
    correct: 'Ð’Ñ–Ñ€Ð½Ð¾! ðŸŽ‰. ÐœÐ¾Ð¶Ð½Ð° Ð½Ð°Ñ‚Ð¸ÑÐ½ÑƒÑ‚Ð¸ "Ð¾Ñ‚Ñ€Ð¸Ð¼Ð°Ñ‚Ð¸ Ð·Ð°Ð³Ð°Ð´ÐºÑƒ" Ñ– Ð¾Ñ‚Ñ€Ð¸Ð¼Ð°Ñ‚Ð¸ Ð½Ð¾Ð²Ñƒ',
    incorrect: 'ÐÐµÐ²Ñ–Ñ€Ð½Ð¾. Ð¡Ð¿Ñ€Ð¾Ð±ÑƒÐ¹Ñ‚Ðµ Ñ–Ð½ÑˆÑƒ (Ð½Ð°Ñ‚Ð¸ÑÐ½Ñ–Ñ‚ÑŒ Ð¾Ñ‚Ñ€Ð¸Ð¼Ð°Ñ‚Ð¸ Ð·Ð°Ð³Ð°Ð´ÐºÑƒ)!',
    answer: 'Ð’Ñ–Ð´Ð¿Ð¾Ð²Ñ–Ð´ÑŒ:',
    riddle: 'Ð—Ð°Ð³Ð°Ð´ÐºÐ°:',
    yourAnswer: 'Ð’Ð°ÑˆÐ° Ð²Ñ–Ð´Ð¿Ð¾Ð²Ñ–Ð´ÑŒ...'
  }
};

function RiddleChat() {
  const [riddle, setRiddle] = useState('');
  const [answer, setAnswer] = useState('');
  const [userAnswer, setUserAnswer] = useState('');
  const [result, setResult] = useState('');
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState('');
  const { lang: contextLang } = useContext(LangContext);
  const [lang, setLang] = useState(contextLang || 'eng');

  useEffect(() => {
    const user = auth.currentUser;
    if (user) {
      const userRef = ref(db, `users/${user.uid}`);
      get(userRef).then((snapshot) => {
        const data = snapshot.val();
        if (data && data.lang) {
          setLang(data.lang);
        }
        if (!data) {
          set(userRef, {
            username: user.displayName || user.email,
            score: 0,
            lang: 'eng',
          });
          set(ref(db, `leaderboard/${user.uid}`), {
            username: user.displayName || user.email,
            score: 0,
          });
        }
      });
    }
  }, []);

  useEffect(() => { setLang(contextLang); }, [contextLang]);

  async function getRiddle() {
    setLoading(true);
    setError('');
    setResult('');
    setRiddle('');
    setAnswer('');
    setUserAnswer('');
    try {
      let prompt = '';
      if (lang === 'eng') {
        prompt = 'Come up with an interesting riddle in English and give only the riddle, and write the answer separately. RIDDLE MUST BE IN ENGLISH. Format: Riddle: ... Answer: ...';
      } else if (lang === 'ru') {
        prompt = 'ÐŸÑ€Ð¸Ð´ÑƒÐ¼Ð°Ð¹ Ð¸Ð½Ñ‚ÐµÑ€ÐµÑÐ½ÑƒÑŽ Ð·Ð°Ð³Ð°Ð´ÐºÑƒ Ð½Ð° Ñ€ÑƒÑÑÐºÐ¾Ð¼ ÑÐ·Ñ‹ÐºÐµ Ð¸ Ð´Ð°Ð¹ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð·Ð°Ð³Ð°Ð´ÐºÑƒ, Ð° Ð¾Ñ‚Ð²ÐµÑ‚ Ð½Ð°Ð¿Ð¸ÑˆÐ¸ Ð¾Ñ‚Ð´ÐµÐ»ÑŒÐ½Ð¾. Ð—ÐÐ“ÐÐ”ÐšÐ Ð”ÐžÐ›Ð–ÐÐ Ð‘Ð«Ð¢Ð¬ ÐÐ Ð Ð£Ð¡Ð¡ÐšÐžÐœ. Ð¤Ð¾Ñ€Ð¼Ð°Ñ‚: Ð—Ð°Ð³Ð°Ð´ÐºÐ°: ... ÐžÑ‚Ð²ÐµÑ‚: ...';
      } else if (lang === 'ua') {
        prompt = 'ÐŸÑ€Ð¸Ð´ÑƒÐ¼Ð°Ð¹ Ñ†Ñ–ÐºÐ°Ð²Ñƒ Ð·Ð°Ð³Ð°Ð´ÐºÑƒ ÑƒÐºÑ€Ð°Ñ—Ð½ÑÑŒÐºÐ¾ÑŽ Ð¼Ð¾Ð²Ð¾ÑŽ Ñ– Ð´Ð°Ð¹ Ñ‚Ñ–Ð»ÑŒÐºÐ¸ Ð·Ð°Ð³Ð°Ð´ÐºÑƒ, Ð° Ð²Ñ–Ð´Ð¿Ð¾Ð²Ñ–Ð´ÑŒ Ð½Ð°Ð¿Ð¸ÑˆÐ¸ Ð¾ÐºÑ€ÐµÐ¼Ð¾. Ð—ÐÐ“ÐÐ”ÐšÐ ÐœÐÐ„ Ð‘Ð£Ð¢Ð˜ Ð£ÐšÐ ÐÐ‡ÐÐ¡Ð¬ÐšÐžÐ®. Ð¤Ð¾Ñ€Ð¼Ð°Ñ‚: Ð—Ð°Ð³Ð°Ð´ÐºÐ°: ... Ð’Ñ–Ð´Ð¿Ð¾Ð²Ñ–Ð´ÑŒ: ...';
      }
      const res = await fetch(API_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          contents: [{ parts: [{ text: prompt }] }],
        }),
      });
      const data = await res.json();
      let match;
      if (lang === 'eng') {
        if (data.candidates && data.candidates[0] && data.candidates[0].content && data.candidates[0].content.parts) {
          const text = data.candidates[0].content.parts.map((p) => p.text).join(' ');
          match = text.match(/Riddle:(.*)Answer:(.*)/is);
        }
      } else if (lang === 'ru') {
        if (data.candidates && data.candidates[0] && data.candidates[0].content && data.candidates[0].content.parts) {
          const text = data.candidates[0].content.parts.map((p) => p.text).join(' ');
          match = text.match(/Ð—Ð°Ð³Ð°Ð´ÐºÐ°:(.*)ÐžÑ‚Ð²ÐµÑ‚:(.*)/is);
        }
      } else if (lang === 'ua') {
        if (data.candidates && data.candidates[0] && data.candidates[0].content && data.candidates[0].content.parts) {
          const text = data.candidates[0].content.parts.map((p) => p.text).join(' ');
          match = text.match(/Ð—Ð°Ð³Ð°Ð´ÐºÐ°:(.*)Ð’Ñ–Ð´Ð¿Ð¾Ð²Ñ–Ð´ÑŒ:(.*)/is);
        }
      }
      if (match) {
        setRiddle(match[1].trim());
        setAnswer(match[2].trim());
      } else if (data.error) {
        setError(`Gemini API error: ${data.error.message || 'Unknown error'} (code: ${data.error.code || 'no code'})`);
      } else {
        setError('ÐžÑˆÐ¸Ð±ÐºÐ°: Ð½Ðµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð¿Ð¾Ð»ÑƒÑ‡Ð¸Ñ‚ÑŒ Ð·Ð°Ð³Ð°Ð´ÐºÑƒ. ÐŸÐ¾Ð¿Ñ€Ð¾Ð±ÑƒÐ¹Ñ‚Ðµ ÐµÑ‰Ñ‘ Ñ€Ð°Ð·.');
      }
    } catch (e) {
      setError('API connection error: ' + e.message);
    } finally {
      setLoading(false);
    }
  }

  function normalizeAnswer(ans) {
    return ans
      .toLowerCase()
      .replace(/^(a|an)\s+/g, '')
      .trim();
  }

  function checkAnswer() {
    if (normalizeAnswer(userAnswer) === normalizeAnswer(answer)) {
      setResult(translations[lang].correct);
      const user = auth.currentUser;
      if (user) {
        const userRef = ref(db, `users/${user.uid}`);
        get(userRef).then((snapshot) => {
          const data = snapshot.val() || { score: 0, username: user.displayName || user.email };
          const newScore = (data.score || 0) + 1;
          set(userRef, {
            ...data,
            score: newScore,
          });
          set(ref(db, `leaderboard/${user.uid}`), {
            username: data.username,
            score: newScore,
          });
        });
      }
    } else {
      setResult(translations[lang].incorrect);
    }
  }

  return (
    <div className="riddle-chat-container">
      <h2 className="riddle-chat-title">
        {translations[lang].title}
        <img src="/gemini-logo.png" alt="Gemini logo" style={{ height: '1.2em', verticalAlign: 'middle' }} />
      </h2>
      <p className="riddle-text">
        {translations[lang].description}
      </p>
      <button
        onClick={getRiddle}
        disabled={loading}
        className={`riddle-chat-button ${loading ? 'riddle-chat-button-disabled' : ''}`}
      >
        {loading ? translations[lang].generating : translations[lang].getRiddle}
      </button>
      {error && <div className="riddle-chat-error">{error}</div>}
      {riddle && (
        <div className="riddle-chat-content">
          <div className="riddle-chat-label">{translations[lang].riddle}</div>
          <div className="riddle-chat-riddle">{riddle}</div>
          <div className="riddle-chat-input-row">
            <input
              type="text"
              placeholder={translations[lang].yourAnswer}
              value={userAnswer}
              onChange={(e) => setUserAnswer(e.target.value)}
              className="riddle-chat-input"
              disabled={!!result}
            />
            <button
              onClick={checkAnswer}
              className="riddle-chat-check-button"
              disabled={!!result}
            >
              {translations[lang].check}
            </button>
          </div>
          {result && <div className="riddle-chat-result">{result}</div>}
          {answer && result && <div className="riddle-chat-answer">{translations[lang].answer} {answer}</div>}
        </div>
      )}
    </div>
  );
}

export default RiddleChat;